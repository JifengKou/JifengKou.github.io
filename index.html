<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

<style>
h1 {
  font-size: 39px;
  font-family: Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif;
  text-align: left;
  padding-left: 50px;
  color: #82853c;
}
h2 {
  font-size: 18px;
  font-family: Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif;
  text-align: left;
  padding-left: 10px;
  color: #7f7fc5;
}
/* Body text on page */
body {
  background-color: #fffcea;
  font-size: 11px;
  font-family: Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif;
}
/* All labels on charts */
.labels {
  font-size: 12px;
  font-weight: bold;
  font-family: Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif;
}
  
  .bar text.value {
  fill: #00008B;
}
.axis {
  shape-rendering: crispEdges;
}
.axis path {
  fill: none;
}
.x.axis line {
  stroke: #000;
  stroke-opacity: 0.2;
}
.y.axis path {
  stroke: black;
}
  
 

</style>
<body>
  <h1>Los Angeles occured accident on Aug 23 2014</h1>


<script>
 
  d3.csv('CS2102_Majors_and_Years_Each_Year.csv', function(err, data) {
    if(err) console.log(err);

    data = aggregateByDate(data);

    buildVis(data);

  });

  function aggregateByDate(data){
    var arrayOfStudents = d3.nest()
    arrayOfStudents = d3.nest()
    .key(function(data) { return data.TermAndYearTaken; })
    .entries(data);
    return arrayOfStudents;
  }

  function aggregateByDRNO(data){
    var arrayOfStudents = d3.nest()
    arrayOfStudents = d3.nest()
    .key(function(data) { return data.DRNO; })
    .entries(data);
    return arrayOfStudents;
  }

  function aggregateByYear(data){
    var arrayOfStudents = d3.nest()
    arrayOfStudents = d3.nest()
    .key(function(data) { 
      return data.Year; })
    .entries(data);
    return arrayOfStudents;
  }

    function buildVis(data) {

      var color = d3.scale.ordinal()
      .range(["#9eeff4", "#62e6ed" , "#3ee1e9", "#18d6e0", "#16c0c9", "#9ed0f4", "#59afec" , "#55adec", "#42a4ea", "#309be8", "#67afee", "#429cea", "#3997e9", "#2b8fe7", "#228be6", "#67ee9f", "#39e982", "#2be77a", "#1ee671","#17d767"]);

    console.log(data);

    var width = 1800,
    height = 500,
    radius = Math.min(width, height) / 2;
    var centerPlacement = width / 2;
    // Outer and inner radii
    var outerRadius = 200;
    var innerRadius = 80;    
 
    var vis = d3.select("body")
    .data([data])
    .append("svg:svg") 
    .attr("width", width)
    .attr("height", height)
    .append("svg:g") 
    .attr("transform", "translate(" + 200 + "," + 300 + ")");
  
    var arc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(outerRadius);

    var pie = d3.layout.pie()
          .value(function(d) { return d.values.length; }); 
     var arcs = vis.selectAll("g.slice") 
     .data(pie)
     .enter()
     .append("svg:g")
     .attr("class", "slice")
    
      .on("mouseover", function(d, i) {  
            d3.select(this)
            .attr("fill", "#a54a5e");
           })
     
     .on("click", function(d, i) {
         d3.select("svg.secondChart")
         .remove();
         d3.select("svg.thirdChart")
         .remove();
       buildSecondVis(data[i], data[i].key);
     })
          .on("mouseout", function() {
            d3.select(this)
              .attr("fill", "#000000");
        });
 
        arcs.append("svg:path")
        .attr("fill", function(d, i) { 
          return color(i); } )
        .attr("d", arc);
        
        arcs.append("svg:text")
          .attr("class", "labels")
          .attr("transform", function(d) {
          
          return "translate(" + arc.centroid(d) + ")rotate(" + angle(d) + ")";
          })
          
          .attr("text-anchor", "middle")
 
          .text(function(d, i) { 
            return data[i].key + ": " + data[i].values.length; 
          });
        }

   function angle(d) {
    var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
    return a > 90 ? a - 180 : a;
  }
 
  
  
  
  
  
  
  
  
  function buildSecondVis(data, dataName) {
      
      data = aggregateByYear(data.values);
      var w = 650;
      var h = 500;
      var format = d3.format(",.0f");
      var x = d3.scale.linear().range([0, 270]),
          y = d3.scale.ordinal().rangeRoundBands([0, h-50], .2);
      var xAxis = d3.svg.axis().scale(x).orient("top").tickSize(-h),
          yAxis = d3.svg.axis().scale(y).orient("left").tickSize(0);
      var svg = d3.select("body").append("svg")
          .attr('class', 'secondChart')
          .attr("width", w)
          .attr("height", h)
        .append("g")
          .attr("transform", "translate(" + 350 + "," + 10 + ")");
      
      data.forEach(function(d) { 
        d.value = +d.value; });
      data.sort(function(a, b) { return b.value - a.value; });
      // Set the scale domain.
      x.domain([0, d3.max(data, function(d) {
        // This is working
        return d.values.length; 
      })]);
      y.domain(data.map(function(d) { 
        return d.key; }));
      // Adding x axis to screen
      svg.append("g")
          .attr("class", "x axis")
          .call(xAxis);
      // Adding y axis to screen
      svg.append("g")
          .attr("class", "y axis")
          .call(yAxis);
      var bar = svg.selectAll("g.bar")
          .data(data)
        .enter().append("g")
          .attr("class", "bar")
          .attr("transform", function(d) {
            return "translate(1," + y(d.key) + ")"; 
          });
      // Putting the rectangles on the bar chart
      bar.append("rect")
          .attr("fill", "#80c6af")
          .attr("width", function(d, i) {
            // This is working
            return x(d.values.length); 
          })
          .attr("height", y.rangeBand())
          .on("mouseover", function(d, i) {
 
            d3.select(this)
              .attr("fill", "#b1dcce");
           })
      
          .on("click", function(d, i) {
            d3.select("svg.thirdChart")
            .remove();
            buildThirdVis(data[i]);
         })
          .on("mouseout", function() {
            d3.select(this)
              .attr("fill", "#80c6af");
        });
      // Placing the label text for each bar
      bar.append("text")
          .attr("class", "value")
          .attr("x", function(d) { 
            return x(d.values.length); 
          })
          .attr("y", y.rangeBand() / 2)
          .attr("dx", 20)
          .attr("dy", ".35em")
          .attr("text-anchor", "end")
          .text(function(d) {
            return format(d.values.length); 
          });
  
    }
 
  
     
  
  
 
    </script>
</body>
